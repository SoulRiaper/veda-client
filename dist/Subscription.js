import u from"./defaults.js";import{timeout as o}from"./Util.js";export default class e{static#i;#n;#r;#s=[];#t=new Map;#o=new FinalizationRegistry(s=>{this.unsubscribe(s)});constructor(s=u.ccus){if(e.#i)return e.#i;this.#n=s,this.#e(),e.#i=this}async#e(s){s&&await o(3e4);const t=new WebSocket(this.#n);t.onopen=this.#h.bind(this),t.onclose=this.#e.bind(this),t.onerror=this.#e.bind(this),t.onmessage=this.#c.bind(this),this.#r=t}async#h(){this.#s.length&&(this.#r.send(this.#s.join(",")),this.#s.length=0),await o(1e3),this.#h()}#c({data:s}){if(s==="")return;const t=(s.indexOf("=")===0?s.substr(1):s).split(",");for(const i of t){const n=i.split("="),[r,c]=n,h=this.#t.get(r);if(!h)this.unsubscribe(r);else{const[a]=h.slice(-1);a(r,Number(c))}}}subscribe(s,t){const[i,n]=t;this.#t.has(i)||(this.#t.set(i,t),this.#o.register(s,i),this.#s.push(`+${i}=${n||0}`))}unsubscribe(s){this.#t.delete(s),this.#s.push(`-${s}`)}}
